generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Auth & Users ────────────────────────────────────────────────────

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  avatarUrl    String?  @map("avatar_url")
  phone        String?
  dateOfBirth  String?  @map("date_of_birth")
  bio          String?
  bodyWeight   Float?   @map("body_weight")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  refreshTokens   RefreshToken[]
  settings        UserSettings?
  workouts        Workout[]
  exercises       ExerciseLibrary[]
  measurements    BodyMeasurement[]
  goals           UserGoal[]
  personalRecords PersonalRecord[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model UserSettings {
  id                      String  @id @default(uuid())
  userId                  String  @unique @map("user_id")
  weightUnit              String  @default("lbs") @map("weight_unit")
  distanceUnit            String  @default("US") @map("distance_unit")
  weightCalcMode          String  @default("1x") @map("weight_calc_mode")
  repsConfigMode          String  @default("1x") @map("reps_config_mode")
  defaultRestTimerSeconds Int     @default(90) @map("default_rest_timer_seconds")
  vibrateOnTimerFinish    Boolean @default(true) @map("vibrate_on_timer_finish")
  keepScreenAwake         Boolean @default(true) @map("keep_screen_awake")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// ─── Exercise Library (user custom exercises) ────────────────────────

model ExerciseLibrary {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  name             String
  category         String   @default("Lifts")
  assistedNegative Boolean  @default(false) @map("assisted_negative")
  config           Json?    @default("{}")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutExercises WorkoutExercise[]
  goals            UserGoal[]
  personalRecords  PersonalRecord[]

  @@map("exercise_library")
}

// ─── Workouts ────────────────────────────────────────────────────────

model Workout {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  name         String
  startedAt    DateTime  @map("started_at")
  finishedAt   DateTime? @map("finished_at")
  duration     String?
  sessionNotes Json?     @default("[]") @map("session_notes")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercises WorkoutExercise[]

  @@index([userId])
  @@map("workouts")
}

model WorkoutExercise {
  id           String  @id @default(uuid())
  workoutId    String  @map("workout_id")
  exerciseId   String? @map("exercise_id")
  exerciseName String  @map("exercise_name")
  category     String  @default("Lifts")
  position     Int
  notes        Json?   @default("[]")

  // Superset/group support
  parentId  String? @map("parent_id")
  groupType String? @map("group_type")

  // Exercise config snapshot (weight calc mode, etc.)
  config Json? @default("{}")

  workout  Workout           @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise ExerciseLibrary?  @relation(fields: [exerciseId], references: [id], onDelete: SetNull)
  parent   WorkoutExercise?  @relation("ExerciseGroup", fields: [parentId], references: [id], onDelete: Cascade)
  children WorkoutExercise[] @relation("ExerciseGroup")
  sets     WorkoutSet[]

  @@index([workoutId])
  @@map("workout_exercises")
}

model WorkoutSet {
  id                String  @id @default(uuid())
  workoutExerciseId String  @map("workout_exercise_id")
  position          Int
  type              String  @default("Working")
  weight            String  @default("")
  weight2           String? @default("")
  reps              String  @default("")
  reps2             String? @default("")
  duration          String  @default("")
  distance          String  @default("")
  completed         Boolean @default(false)
  isWarmup          Boolean @default(false) @map("is_warmup")
  isDropset         Boolean @default(false) @map("is_dropset")
  isFailure         Boolean @default(false) @map("is_failure")
  restPeriodSeconds Int?    @map("rest_period_seconds")
  dropSetId         String? @map("drop_set_id")

  workoutExercise WorkoutExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)

  @@index([workoutExerciseId])
  @@map("workout_sets")
}

// ─── Body Measurements ───────────────────────────────────────────────

model BodyMeasurement {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  date              DateTime
  weight            Float?
  bodyFatPercent    Float?   @map("body_fat_percent")
  neck              Float?
  chest             Float?
  waist             Float?
  leftArm           Float?   @map("left_arm")
  rightArm          Float?   @map("right_arm")
  leftThigh         Float?   @map("left_thigh")
  rightThigh        Float?   @map("right_thigh")
  unit              String   @default("lbs")
  circumferenceUnit String   @default("in") @map("circumference_unit")
  createdAt         DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("body_measurements")
}

// ─── Goals ───────────────────────────────────────────────────────────

model UserGoal {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  type                  String
  exerciseId            String?  @map("exercise_id")
  targetWeight          Float?   @map("target_weight")
  targetWeightUnit      String?  @map("target_weight_unit")
  targetWorkoutsPerWeek Int?     @map("target_workouts_per_week")
  completed             Boolean  @default(false)
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise ExerciseLibrary? @relation(fields: [exerciseId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("user_goals")
}

// ─── Personal Records ────────────────────────────────────────────────

model PersonalRecord {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  exerciseId String   @map("exercise_id")
  weight     Float
  weightUnit String   @default("lbs") @map("weight_unit")
  achievedAt DateTime @map("achieved_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise ExerciseLibrary @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([exerciseId])
  @@map("personal_records")
}

// ─── App Config (for runtime switches like reference data source) ────

model AppConfig {
  key   String @id
  value String

  @@map("app_config")
}

// ─── Source Type Enum ─────────────────────────────────────────────────

enum SourceType {
  seed
  admin

  @@map("source_type")
}

// ─── Reference Metadata (version tracking per table) ─────────────────

model ReferenceMetadata {
  tableName   String   @id @map("table_name")
  versionSeq  BigInt   @default(0) @map("version_seq")
  lastUpdated DateTime @default(now()) @map("last_updated") @db.Timestamptz

  @@map("reference_metadata")
}

// ─── Reference Tables ────────────────────────────────────────────────

model RefExerciseCategory {
  id                       String     @id
  label                    String
  technicalName            String?    @map("technical_name")
  commonNames              Json?      @default("[]") @map("common_names")
  shortDescription         String?    @map("short_description")
  exerciseInputPermissions Json?      @map("exercise_input_permissions")
  sortOrder                Int        @default(0) @map("sort_order")
  icon                     String?    @default("")
  isActive                 Boolean    @default(true) @map("is_active")
  sourceType               SourceType @default(seed) @map("source_type")

  @@map("exercise_categories")
}

model RefCardioType {
  id               String     @id
  label            String
  technicalName    String?    @map("technical_name")
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("cardio_types")
}

model RefTrainingFocus {
  id               String     @id
  label            String
  technicalName    String?    @map("technical_name")
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("training_focus")
}

model RefMuscle {
  id               String     @id
  label            String
  parentIds        Json?      @default("[]") @map("parent_ids")
  commonNames      Json?      @default("[]") @map("common_names")
  technicalName    String?    @map("technical_name")
  shortDescription String?    @map("short_description")
  function         String?
  location         String?
  triggers         String?
  upperLower       Json?      @default("[]") @map("upper_lower")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("muscles")
}

model RefMotion {
  id                  String     @id
  label               String
  parentId            String?    @map("parent_id")
  upperLower          Json?      @default("[]") @map("upper_lower")
  muscleTargets       Json?      @map("muscle_targets")
  defaultDeltaConfigs Json?      @map("default_delta_configs")
  commonNames         Json?      @default("[]") @map("common_names")
  shortDescription    String?    @map("short_description")
  sortOrder           Int        @default(0) @map("sort_order")
  icon                String?    @default("")
  isActive            Boolean    @default(true) @map("is_active")
  sourceType          SourceType @default(seed) @map("source_type")

  parent   RefMotion?  @relation("MotionParent", fields: [parentId], references: [id], onUpdate: Cascade, onDelete: Restrict)
  children RefMotion[] @relation("MotionParent")

  @@index([parentId])
  @@map("motions")
}

model RefGrip {
  id               String     @id
  label            String
  parentId         String?    @map("parent_id")
  isDynamic        Boolean    @default(false) @map("is_dynamic")
  gripCategory     String?    @map("grip_category")
  rotationPath     Json?      @map("rotation_path")
  commonNames      Json?      @default("[]") @map("common_names")
  deltaRules       Json?      @map("delta_rules")
  shortDescription String?    @map("short_description")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  parent   RefGrip?  @relation("GripParent", fields: [parentId], references: [id], onUpdate: Cascade, onDelete: Restrict)
  children RefGrip[] @relation("GripParent")

  @@index([parentId])
  @@map("grips")
}

model RefEquipmentCategory {
  id               String     @id
  label            String
  parentId         String?    @map("parent_id")
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  parent    RefEquipmentCategory?  @relation("EquipCatParent", fields: [parentId], references: [id], onUpdate: Cascade, onDelete: Restrict)
  children  RefEquipmentCategory[] @relation("EquipCatParent")
  equipment RefEquipment[]

  @@index([parentId])
  @@map("equipment_categories")
}

model RefMotionPath {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  deltaRules       Json?      @map("delta_rules")
  shortDescription String?    @map("short_description")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("motion_paths")
}

model RefTorsoAngle {
  id                     String     @id
  label                  String
  commonNames            Json?      @default("[]") @map("common_names")
  shortDescription       String?    @map("short_description")
  deltaRules             Json?      @map("delta_rules")
  angleRange             Json?      @map("angle_range")
  allowTorsoOrientations Boolean    @default(false) @map("allow_torso_orientations")
  sortOrder              Int        @default(0) @map("sort_order")
  icon                   String?    @default("")
  isActive               Boolean    @default(true) @map("is_active")
  sourceType             SourceType @default(seed) @map("source_type")

  @@map("torso_angles")
}

model RefTorsoOrientation {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  deltaRules       Json?      @map("delta_rules")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("torso_orientations")
}

model RefResistanceOrigin {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  deltaRules       Json?      @map("delta_rules")
  shortDescription String?    @map("short_description")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("resistance_origin")
}

model RefGripWidth {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  deltaRules       Json?      @map("delta_rules")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("grip_widths")
}

model RefElbowRelationship {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  deltaRules       Json?      @map("delta_rules")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("elbow_relationship")
}

model RefExecutionStyle {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  deltaRules       Json?      @map("delta_rules")
  shortDescription String?    @map("short_description")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("execution_styles")
}

model RefFootPosition {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  deltaRules       Json?      @map("delta_rules")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("foot_positions")
}

model RefStanceWidth {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  deltaRules       Json?      @map("delta_rules")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("stance_widths")
}

model RefStanceType {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  deltaRules       Json?      @map("delta_rules")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("stance_types")
}

model RefLoadPlacement {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  loadCategory     String?    @map("load_category")
  allowsSecondary  Boolean    @default(false) @map("allows_secondary")
  isValidSecondary Boolean    @default(false) @map("is_valid_secondary")
  deltaRules       Json?      @map("delta_rules")
  shortDescription String?    @map("short_description")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("load_placement")
}

model RefSupportStructure {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  deltaRules       Json?      @map("delta_rules")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("support_structures")
}

model RefLoadingAid {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  deltaRules       Json?      @map("delta_rules")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("loading_aids")
}

model RefRangeOfMotion {
  id               String     @id
  label            String
  commonNames      Json?      @default("[]") @map("common_names")
  shortDescription String?    @map("short_description")
  deltaRules       Json?      @map("delta_rules")
  sortOrder        Int        @default(0) @map("sort_order")
  icon             String?    @default("")
  isActive         Boolean    @default(true) @map("is_active")
  sourceType       SourceType @default(seed) @map("source_type")

  @@map("range_of_motion")
}

model RefEquipment {
  id                  String     @id
  label               String
  categoryId          String?    @map("category_id")
  commonNames         Json?      @default("[]") @map("common_names")
  shortDescription    String?    @map("short_description")
  isAttachment        Boolean    @default(false) @map("is_attachment")
  requiresAttachment  Boolean    @default(false) @map("requires_attachment")
  maxInstances        Int        @default(1) @map("max_instances")
  modifierConstraints Json?      @map("modifier_constraints")
  sortOrder           Int        @default(0) @map("sort_order")
  icon                String?    @default("")
  isActive            Boolean    @default(true) @map("is_active")
  sourceType          SourceType @default(seed) @map("source_type")

  category RefEquipmentCategory? @relation(fields: [categoryId], references: [id], onUpdate: Cascade, onDelete: Restrict)

  @@index([categoryId])
  @@map("equipment")
}

model RefEquipmentIcon {
  id         String     @id
  value      String
  isActive   Boolean    @default(true) @map("is_active")
  sourceType SourceType @default(seed) @map("source_type")

  @@map("equipment_icons")
}
